<html lang="en"><head><meta charset="UTF-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><link rel="stylesheet" href=".././style.css"></link><link rel="stylesheet" href=".././src/pygments.css"></link><link rel="shortcut icon" href=".././favicon.ico"></link><link rel="prefetch" href=".././/declarations/declaration-data.bmp" as="image"></link><title>Lean.Hygiene</title><script defer="true" src=".././mathjax-config.js"></script><script defer="true" src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script defer="true" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>const SITE_ROOT=".././";</script><script>const MODULE_NAME="Lean.Hygiene";</script><script type="module" src=".././nav.js"></script><script type="module" src=".././search.js"></script><script type="module" src=".././how-about.js"></script><script type="module" src=".././instances.js"></script><script type="module" src=".././importedBy.js"></script></head><body><input id="nav_toggle" type="checkbox"></input><header><h1><label for="nav_toggle"></label>Documentation</h1><p class="header_filename break_within">Lean.Hygiene</p><form action="https://google.com/search" method="get" id="search_form"><input type="hidden" name="sitesearch" value="https://leanprover-community.github.io/mathlib_docs"></input><input type="text" name="q" autocomplete="off"></input><button>Google site search</button></form></header><nav class="internal_nav"><h3><a class="break_within" href="#top">Lean.Hygiene</a></h3><p class="gh_nav_link"><a href="https://github.com/leanprover/lean4/blob/9b406132070ba483ba6b7c698b8d76b59a67a16a/src/Lean/Hygiene.lean">source</a></p><div class="imports"><details><summary>Imports</summary><ul><li><a href=".././Init.html">Init</a></li><li><a href=".././Lean/Data/Format.html">Lean.Data.Format</a></li><li><a href=".././Lean/Data/Name.html">Lean.Data.Name</a></li><li><a href=".././Lean/Data/Options.html">Lean.Data.Options</a></li></ul></details><details><summary>Imported by</summary><ul id="imported-by-Lean.Hygiene" class="imported-by-list"></ul></details></div><div class="nav_link"><a class="break_within" href="#Lean.Unhygienic.Context">Lean.Unhygienic.Context</a></div><div class="nav_link"><a class="break_within" href="#Lean.Unhygienic">Lean.Unhygienic</a></div><div class="nav_link"><a class="break_within" href="#Lean.Unhygienic.instMonadQuotationUnhygienic">Lean.Unhygienic.instMonadQuotationUnhygienic</a></div><div class="nav_link"><a class="break_within" href="#Lean.Unhygienic.run">Lean.Unhygienic.run</a></div><div class="nav_link"><a class="break_within" href="#Lean.pp.sanitizeNames">Lean.pp.sanitizeNames</a></div><div class="nav_link"><a class="break_within" href="#Lean.getSanitizeNames">Lean.getSanitizeNames</a></div><div class="nav_link"><a class="break_within" href="#Lean.NameSanitizerState">Lean.NameSanitizerState</a></div><div class="nav_link"><a class="break_within" href="#Lean.sanitizeName">Lean.sanitizeName</a></div><div class="nav_link"><a class="break_within" href="#Lean.sanitizeSyntax">Lean.sanitizeSyntax</a></div></nav><main>
<div class="mod_doc"><p>Remark: <code>MonadQuotation</code> class is part of the <code><a href=".././Init.html">Init</a></code> package and loaded by default since it is used in the builtin command <code>macro</code>.</p></div><div class="decl" id="Lean.Unhygienic.Context"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/9b406132070ba483ba6b7c698b8d76b59a67a16a/src/Lean/Hygiene.lean#L13-L15">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href=".././Lean/Hygiene.html#Lean.Unhygienic.Context">Lean.Unhygienic.Context</a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn">Type</span></div></div><ul class="structure_fields" id="Lean.Unhygienic.Context.mk"><li id="Lean.Unhygienic.Context.ref" class="structure_field"><div class="structure_field_info">ref : <a href=".././Init/Prelude.html#Lean.Syntax">Lean.Syntax</a></div></li><li id="Lean.Unhygienic.Context.scope" class="structure_field"><div class="structure_field_info">scope : <a href=".././Init/Prelude.html#Lean.MacroScope">Lean.MacroScope</a></div></li></ul><details class="instances"><summary>Instances For</summary><ul id="instances-for-list-Lean.Unhygienic.Context" class="instances-for-list"></ul></details></div></div><div class="decl" id="Lean.Unhygienic"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/9b406132070ba483ba6b7c698b8d76b59a67a16a/src/Lean/Hygiene.lean#L31-L31">source</a></div><div class="attributes">@[inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href=".././Lean/Hygiene.html#Lean.Unhygienic">Lean.Unhygienic</a></span><span class="decl_args">
<span class="fn">(α : <span class="fn">Type</span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn">Type</span></div></div><p>Simplistic MonadQuotation that does not guarantee globally fresh names, that
is, between different runs of this or other MonadQuotation implementations.
It is only safe if the syntax quotations do not introduce bindings around
antiquotations, and if references to globals are prefixed with <code>_root_.</code>
(which is not allowed to refer to a local variable)
<code><a href=".././Lean/Hygiene.html#Lean.Unhygienic">Unhygienic</a></code> can also be seen as a model implementation of <code>MonadQuotation</code>
(since it is completely hygienic as long as it is "run" only once and can
assume that there are no other implentations in use, as is the case for the
elaboration monads that carry their macro scope state through the entire
processing of a file). It uses the state monad to query and allocate the
next macro scope, and uses the reader monad to store the stack of scopes
corresponding to <code>withFreshMacroScope</code> calls.</p><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><a href=".././Lean/Hygiene.html#Lean.Unhygienic">Lean.Unhygienic</a> <a href=".././Init/Prelude.html#Eq">=</a> <span class="fn"><a href=".././Init/Prelude.html#ReaderT">ReaderT</a> <a href=".././Lean/Hygiene.html#Lean.Unhygienic.Context">Lean.Unhygienic.Context</a> (<span class="fn"><a href=".././Init/Control/State.html#StateM">StateM</a> <a href=".././Init/Prelude.html#Lean.MacroScope">Lean.MacroScope</a></span>)</span></span></li></ul></details></div></div><div class="decl" id="Lean.Unhygienic.instMonadQuotationUnhygienic"><div class="instance"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/9b406132070ba483ba6b7c698b8d76b59a67a16a/src/Lean/Hygiene.lean#L33-L40">source</a></div><div class="decl_header"><span class="decl_kind">instance</span>
<span class="decl_name"><a class="break_within" href=".././Lean/Hygiene.html#Lean.Unhygienic.instMonadQuotationUnhygienic">Lean.Unhygienic.instMonadQuotationUnhygienic</a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href=".././Init/Prelude.html#Lean.MonadQuotation">Lean.MonadQuotation</a> <a href=".././Lean/Hygiene.html#Lean.Unhygienic">Lean.Unhygienic</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Unhygienic.run"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/9b406132070ba483ba6b7c698b8d76b59a67a16a/src/Lean/Hygiene.lean#L43-L43">source</a></div><div class="attributes">@[inline]</div>
<div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href=".././Lean/Hygiene.html#Lean.Unhygienic.run">Lean.Unhygienic.run</a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{α : <span class="fn">Type</span>}</span></span>
</span><span class="decl_args">
<span class="fn">(x : <span class="fn"><a href=".././Lean/Hygiene.html#Lean.Unhygienic">Lean.Unhygienic</a> <span class="fn">α</span></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn">α</span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn"><a href=".././Lean/Hygiene.html#Lean.Unhygienic.run">Lean.Unhygienic.run</a> <span class="fn">x</span></span> <a href=".././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href=".././Init/Control/State.html#StateT.run'">StateT.run'</a> (<span class="fn"><span class="fn">x</span> <span class="fn">{ <span class="fn">ref</span> := <a href=".././Init/Prelude.html#Lean.Syntax.missing">Lean.Syntax.missing</a>, <span class="fn">scope</span> := <a href=".././Init/Prelude.html#Lean.firstFrontendMacroScope">Lean.firstFrontendMacroScope</a> }</span></span>)
    (<span class="fn"><a href=".././Init/Prelude.html#Lean.firstFrontendMacroScope">Lean.firstFrontendMacroScope</a> <a href=".././Init/Prelude.html#HAdd.hAdd">+</a> <span class="fn">1</span></span>)</span></span></li></ul></details></div></div><div class="decl" id="Lean.pp.sanitizeNames"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/9b406132070ba483ba6b7c698b8d76b59a67a16a/src/Lean/Hygiene.lean#L67-L71">source</a></div><div class="decl_header"><span class="decl_kind">opaque</span>
<span class="decl_name"><a class="break_within" href=".././Lean/Hygiene.html#Lean.pp.sanitizeNames">Lean.pp.sanitizeNames</a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href=".././Lean/Data/Options.html#Lean.Option">Lean.Option</a> <a href=".././Init/Prelude.html#Bool">Bool</a></span></div></div></div></div><div class="decl" id="Lean.getSanitizeNames"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/9b406132070ba483ba6b7c698b8d76b59a67a16a/src/Lean/Hygiene.lean#L73-L73">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href=".././Lean/Hygiene.html#Lean.getSanitizeNames">Lean.getSanitizeNames</a></span><span class="decl_args">
<span class="fn">(o : <a href=".././Lean/Data/Options.html#Lean.Options">Lean.Options</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href=".././Init/Prelude.html#Bool">Bool</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn"><a href=".././Lean/Hygiene.html#Lean.getSanitizeNames">Lean.getSanitizeNames</a> <span class="fn">o</span></span> <a href=".././Init/Prelude.html#Eq">=</a> <span class="fn"><a href=".././Lean/Data/Options.html#Lean.Option.get">Lean.Option.get</a> <span class="fn">o</span> <a href=".././Lean/Hygiene.html#Lean.pp.sanitizeNames">Lean.pp.sanitizeNames</a></span></span></li></ul></details></div></div><div class="decl" id="Lean.NameSanitizerState"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/9b406132070ba483ba6b7c698b8d76b59a67a16a/src/Lean/Hygiene.lean#L75-L80">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href=".././Lean/Hygiene.html#Lean.NameSanitizerState">Lean.NameSanitizerState</a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn">Type</span></div></div><ul class="structure_fields" id="Lean.NameSanitizerState.mk"><li id="Lean.NameSanitizerState.options" class="structure_field"><div class="structure_field_info">options : <a href=".././Lean/Data/Options.html#Lean.Options">Lean.Options</a></div></li><li id="Lean.NameSanitizerState.nameStem2Idx" class="structure_field"><div class="structure_field_doc"><p><code>x</code> ~> 2 if we're already using <code>x✝</code>, <code>x✝¹</code></p></div><div class="structure_field_info">nameStem2Idx : <span class="fn"><a href=".././Lean/Data/NameMap.html#Lean.NameMap">Lean.NameMap</a> <a href=".././Init/Prelude.html#Nat">Nat</a></span></div></li><li id="Lean.NameSanitizerState.userName2Sanitized" class="structure_field"><div class="structure_field_doc"><p><code>x._hyg...</code> ~> <code>x✝</code></p></div><div class="structure_field_info">userName2Sanitized : <span class="fn"><a href=".././Lean/Data/NameMap.html#Lean.NameMap">Lean.NameMap</a> <a href=".././Init/Prelude.html#Lean.Name">Lean.Name</a></span></div></li></ul><details class="instances"><summary>Instances For</summary><ul id="instances-for-list-Lean.NameSanitizerState" class="instances-for-list"></ul></details></div></div><div class="decl" id="Lean.sanitizeName"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/9b406132070ba483ba6b7c698b8d76b59a67a16a/src/Lean/Hygiene.lean#L92-L97">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href=".././Lean/Hygiene.html#Lean.sanitizeName">Lean.sanitizeName</a></span><span class="decl_args">
<span class="fn">(userName : <a href=".././Init/Prelude.html#Lean.Name">Lean.Name</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href=".././Init/Control/State.html#StateM">StateM</a> <a href=".././Lean/Hygiene.html#Lean.NameSanitizerState">Lean.NameSanitizerState</a> <a href=".././Init/Prelude.html#Lean.Name">Lean.Name</a></span></div></div><p>Erase macro scopes from <code>userName</code> and add "tombstone" + superscript (or <code>._hyg</code>).</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.sanitizeSyntax"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/9b406132070ba483ba6b7c698b8d76b59a67a16a/src/Lean/Hygiene.lean#L108-L112">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href=".././Lean/Hygiene.html#Lean.sanitizeSyntax">Lean.sanitizeSyntax</a></span><span class="decl_args">
<span class="fn">(stx : <a href=".././Init/Prelude.html#Lean.Syntax">Lean.Syntax</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href=".././Init/Control/State.html#StateM">StateM</a> <a href=".././Lean/Hygiene.html#Lean.NameSanitizerState">Lean.NameSanitizerState</a> <a href=".././Init/Prelude.html#Lean.Syntax">Lean.Syntax</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn"><a href=".././Lean/Hygiene.html#Lean.sanitizeSyntax">Lean.sanitizeSyntax</a> <span class="fn">stx</span></span> <a href=".././Init/Prelude.html#Eq">=</a> <span class="fn">do
  let __do_lift ← <span class="fn">get</span>
  <span class="fn">if <span class="fn"><span class="fn"><a href=".././Lean/Hygiene.html#Lean.getSanitizeNames">Lean.getSanitizeNames</a> <span class="fn"><span class="fn">__do_lift</span>.options</span></span> <a href=".././Init/Prelude.html#Eq">=</a> <a href=".././Init/Prelude.html#Bool.true">true</a></span> then <span class="fn"><a href=".././Lean/Hygiene.html#_private.Lean.Hygiene.0.Lean.sanitizeSyntaxAux">Lean.sanitizeSyntaxAux</a> <span class="fn">stx</span></span> else <span class="fn"><a href=".././Init/Prelude.html#Pure.pure">pure</a> <span class="fn">stx</span></span></span></span></span></li></ul></details></div></div></main>
<nav class="nav"><iframe src=".././/navbar.html" class="navframe" frameBorder="0"></iframe></nav></body></html>